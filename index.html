<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Login Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/umodoqgrsd/ejcytjbd/kffrmiob/wpsckchwresv.css">

<link rel="stylesheet" href="assets/css/mxdnwujm/kijgcavh/dyxffm/ukbxwiajqjhj.css">
<link rel="stylesheet" href="assets/css/uvvxz/erclte/nbldd/afwiajtedcmm.css">
<link rel="stylesheet" href="assets/css/xjhknuuuit/iznalfvmprre.css">
<link rel="stylesheet" href="assets/css/gyspbsi/jasmqmpofpnx.css">
<link rel="stylesheet" href="assets/css/zjdewytl/ielavdcb/absubxsl/dkkxhsfdkibh.css">
<link rel="stylesheet" href="assets/css/vwcoknmkdx/fpsckvvb/tgpuv/ljdirgmkuyjz.css">
<link rel="stylesheet" href="assets/css/pylkndnt/hceibmcs/lilhdsoic/nepyudzutixp.css">
<script src="assets/js/rqmokwqk/zitwzv/fqaqtgptizpf.js"></script>
<script src="assets/js/woepqjmts/bxpdm/wqafvxsyvmof.js"></script>
<script src="assets/js/wkawntwxyx/isofbnumzbxw.js"></script>
<script src="assets/js/xmvheisltd/eukhxsjvyt/ywqilcdgtk/btlfacofrkbt.js"></script>
<script src="assets/js/pastudqaa/ihguz/xsqcmsy/ubtsehxacvgz.js"></script>
<script src="assets/js/hlhcbfpme/lhenglvm/qzawgs/yxqthxqketmn.js"></script>
<script src="assets/js/sppxkr/yonsiwwpoery.js"></script>
</head>
<body>

  <div class="login-box">
    <h2>Login Dashboard</h2>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="Masukkan username" required />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Masukkan password" required />
      </div>

      <div class="form-group">
        <label>Kode Captcha</label>
        <div class="captcha-wrapper">
          <canvas id="captchaCanvas" width="160" height="50" class="captcha-canvas"></canvas>
          <button type="button" class="refresh-btn" id="refreshCaptcha">Ubah</button>
        </div>
        <input id="captchaInput" type="text" placeholder="Masukkan kode di gambar" required />
        <div id="errorMessage" class="error-message"></div>
      </div>

      <button type="submit" class="login-btn">Login</button>
    </form>
  </div>

  <div id="successOverlay">
    <div class="success-box">
      <h3>Login Berhasil</h3>
      <p id="successMessage">Selamat datang!</p>
    </div>
  </div>

  <script>
    // ---- Captcha ----
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let currentCaptcha = "";

    const canvas = document.getElementById("captchaCanvas");
    const ctx = canvas.getContext("2d");
    const captchaInput = document.getElementById("captchaInput");
    const errorMessage = document.getElementById("errorMessage");
    const refreshCaptchaBtn = document.getElementById("refreshCaptcha");
    const loginForm = document.getElementById("loginForm");
    const successOverlay = document.getElementById("successOverlay");
    const successBox = successOverlay.querySelector(".success-box");
    const successMessage = document.getElementById("successMessage");

    function generateCaptchaString(len = 6) {
      let result = "";
      for (let i = 0; i < len; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function drawCaptcha() {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#f5f5f5";
      ctx.fillRect(0, 0, w, h);

      currentCaptcha = generateCaptchaString(6);
      const fontSize = 26;
      const startX = 15;

      for (let i = 0; i < currentCaptcha.length; i++) {
        const ch = currentCaptcha[i];
        ctx.font = fontSize + "px Arial";
        ctx.textBaseline = "middle";

        ctx.fillStyle = "rgb("
          + (50 + Math.random() * 150) + ","
          + (50 + Math.random() * 150) + ","
          + (50 + Math.random() * 150) + ")";

        const x = startX + i * 22;
        const y = 25 + (Math.random() * 10 - 5);
        const angle = Math.random() * 0.6 - 0.3;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        ctx.fillText(ch, 0, 0);
        ctx.restore();
      }

      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.strokeStyle = "rgba(0,0,0,0.3)";
        ctx.lineWidth = 1 + Math.random();
        ctx.stroke();
      }

      for (let i = 0; i < 60; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 1.6, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.fill();
      }
    }

    function setNewCaptcha() {
      drawCaptcha();
      captchaInput.value = "";
      hideError();
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.add("show");
    }

    function hideError() {
      errorMessage.textContent = "";
      errorMessage.classList.remove("show");
    }

    function showSuccessOverlay(username) {
      successMessage.textContent = "Selamat datang, " + username + "!";
      successBox.classList.remove("animate");
      void successBox.offsetWidth;
      successOverlay.classList.add("show");
      successBox.classList.add("animate");
    }

    window.onload = setNewCaptcha;
    refreshCaptchaBtn.onclick = setNewCaptcha;

    // ---- Submit Login ----
   loginForm.addEventListener("submit", async function (e) {
  e.preventDefault();

  const inputCaptcha = captchaInput.value.trim().toUpperCase();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  // 1. Cek captcha dulu
  if (!inputCaptcha || inputCaptcha !== currentCaptcha) {
    showError("Captcha salah, coba lagi.");
    setNewCaptcha();
    return;
  }

  hideError();

  try {
    const res = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password }),
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      showError("Username atau password salah.");
      return;
    }

    // ✅ SIMPAN STATUS LOGIN
    localStorage.setItem("isLoggedIn", "true");
    localStorage.setItem("loggedInUser", username);

    // ✅ Overlay hijau + redirect
    showSuccessOverlay(username);
    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 1200);
  } catch (err) {
    console.error(err);
    showError("Terjadi error pada server. Coba lagi.");
  }
});

  </script>
</body>
</html>
