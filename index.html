<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Login Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }

    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #9ad0ec, #c7b8ea);
    }

    .login-box {
      width: 100%;
      max-width: 380px;
      padding: 28px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 14px;
      box-shadow: 0px 10px 25px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(5px);
    }

    .login-box h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      font-size: 24px;
      color: #333;
    }

    .form-group { margin-bottom: 16px; }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #333;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #aaa;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #4a6fdc;
      box-shadow: 0 0 0 2px rgba(74, 111, 220, 0.2);
    }

    .captcha-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .captcha-canvas {
      border-radius: 8px;
      border: 1px solid #888;
      background: #f2f2f2;
    }

    .refresh-btn {
      border: none;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      background: #e8e8e8;
      font-size: 12px;
    }

    .refresh-btn:hover { background: #d5d5d5; }

    .login-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #4a6fdc;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .login-btn:hover { background: #3b59b8; }

    .error-message {
      display: none;
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      color: #842029;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
    }

    .error-message.show { display: block; }

    /* OVERLAY SUKSES */
    #successOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 1000;
    }
    #successOverlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .success-box {
      background: #d1e7dd;
      border: 1px solid #badbcc;
      color: #0f5132;
      padding: 24px 32px;
      border-radius: 16px;
      text-align: center;
      min-width: 260px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      transform: translateY(40px);
      opacity: 0;
    }

    .success-box h3 {
      margin: 0 0 8px;
      font-size: 22px;
    }

    .success-box p {
      margin: 0;
      font-size: 15px;
    }

    @keyframes slideUp {
      from { transform: translateY(40px); opacity: 0; }
      to   { transform: translateY(0);   opacity: 1; }
    }

    .success-box.animate {
      animation: slideUp 0.5s ease-out forwards;
    }
  </style>
</head>
<body>

  <div class="login-box">
    <h2>Login Dashboard</h2>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="Masukkan username" required />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Masukkan password" required />
      </div>

      <div class="form-group">
        <label>Kode Captcha</label>
        <div class="captcha-wrapper">
          <canvas id="captchaCanvas" width="160" height="50" class="captcha-canvas"></canvas>
          <button type="button" class="refresh-btn" id="refreshCaptcha">Ubah</button>
        </div>
        <input id="captchaInput" type="text" placeholder="Masukkan kode di gambar" required />
        <div id="errorMessage" class="error-message"></div>
      </div>

      <button type="submit" class="login-btn">Login</button>
    </form>
  </div>

  <div id="successOverlay">
    <div class="success-box">
      <h3>Login Berhasil</h3>
      <p id="successMessage">Selamat datang!</p>
    </div>
  </div>

  <script>
    // ---- Captcha ----
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let currentCaptcha = "";

    const canvas = document.getElementById("captchaCanvas");
    const ctx = canvas.getContext("2d");
    const captchaInput = document.getElementById("captchaInput");
    const errorMessage = document.getElementById("errorMessage");
    const refreshCaptchaBtn = document.getElementById("refreshCaptcha");
    const loginForm = document.getElementById("loginForm");
    const successOverlay = document.getElementById("successOverlay");
    const successBox = successOverlay.querySelector(".success-box");
    const successMessage = document.getElementById("successMessage");

    function generateCaptchaString(len = 6) {
      let result = "";
      for (let i = 0; i < len; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function drawCaptcha() {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = "#f5f5f5";
      ctx.fillRect(0, 0, w, h);

      currentCaptcha = generateCaptchaString(6);
      const fontSize = 26;
      const startX = 15;

      for (let i = 0; i < currentCaptcha.length; i++) {
        const ch = currentCaptcha[i];
        ctx.font = fontSize + "px Arial";
        ctx.textBaseline = "middle";

        ctx.fillStyle = "rgb("
          + (50 + Math.random() * 150) + ","
          + (50 + Math.random() * 150) + ","
          + (50 + Math.random() * 150) + ")";

        const x = startX + i * 22;
        const y = 25 + (Math.random() * 10 - 5);
        const angle = Math.random() * 0.6 - 0.3;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        ctx.fillText(ch, 0, 0);
        ctx.restore();
      }

      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.lineTo(Math.random() * w, Math.random() * h);
        ctx.strokeStyle = "rgba(0,0,0,0.3)";
        ctx.lineWidth = 1 + Math.random();
        ctx.stroke();
      }

      for (let i = 0; i < 60; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 1.6, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.fill();
      }
    }

    function setNewCaptcha() {
      drawCaptcha();
      captchaInput.value = "";
      hideError();
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.add("show");
    }

    function hideError() {
      errorMessage.textContent = "";
      errorMessage.classList.remove("show");
    }

    function showSuccessOverlay(username) {
      successMessage.textContent = "Selamat datang, " + username + "!";
      successBox.classList.remove("animate");
      void successBox.offsetWidth;
      successOverlay.classList.add("show");
      successBox.classList.add("animate");
    }

    window.onload = setNewCaptcha;
    refreshCaptchaBtn.onclick = setNewCaptcha;

    // ---- Submit Login ----
   loginForm.addEventListener("submit", async function (e) {
  e.preventDefault();

  const inputCaptcha = captchaInput.value.trim().toUpperCase();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  // 1. Cek captcha dulu
  if (!inputCaptcha || inputCaptcha !== currentCaptcha) {
    showError("Captcha salah, coba lagi.");
    setNewCaptcha();
    return;
  }

  hideError();

  try {
    const res = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password }),
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      showError("Username atau password salah.");
      return;
    }

    // ✅ SIMPAN STATUS LOGIN
    localStorage.setItem("isLoggedIn", "true");
    localStorage.setItem("loggedInUser", username);

    // ✅ Overlay hijau + redirect
    showSuccessOverlay(username);
    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 1200);
  } catch (err) {
    console.error(err);
    showError("Terjadi error pada server. Coba lagi.");
  }
});

  </script>
</body>
</html>
